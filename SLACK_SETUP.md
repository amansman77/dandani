# 단단이 디스코드 일일 보고서 설정 가이드

## 개요
단단이 관리자 대시보드의 서비스 지표를 디스코드로 일일 보고하는 기능을 구현했습니다.

## 기능
- **자동 일일 보고서**: 매일 오전 9시에 자동으로 디스코드에 보고서 전송
- **리텐션 지표**: Day1, Week1, Day7, Day30 리텐션 및 긍정 후기 비율
- **일일 활동 통계**: 활성 사용자, 실천 완료, 피드백 제출, AI 상담 이용 현황
- **이벤트 통계**: 주요 이벤트별 발생 횟수 및 고유 사용자 수
- **세션 통계**: 총 세션, 고유 사용자, 평균 방문/세션, 평균 이벤트/세션
- **30일간 트렌드**: 일별 활성 사용자 트렌드 및 최고/최저 활성일

## 설정 방법

### 1. 디스코드 웹훅 URL 설정

#### 디스코드 웹훅 생성
1. 디스코드 서버에서 채널 설정 → 연동 → 웹훅
2. "새 웹훅" 클릭
3. 웹훅 URL 복사

#### Cloudflare Workers에 시크릿 설정
```bash
cd workers
npx wrangler secret put DISCORD_WEBHOOK_URL
# 프롬프트가 나타나면 디스코드 웹훅 URL 입력
```

### 2. 배포
```bash
cd workers
npx wrangler deploy
```

### 3. 수동 테스트
```bash
# 일일 보고서 데이터 조회
curl -X GET https://dandani-api.amansman77.workers.dev/api/analytics/daily-report

# 디스코드 메시지 전송 테스트
curl -X GET https://dandani-api.amansman77.workers.dev/api/discord/daily-report
```

## API 엔드포인트

### 1. 일일 보고서 데이터 조회
```
GET /api/analytics/daily-report
```
- 어제의 서비스 지표 데이터를 JSON 형태로 반환
- 리텐션 지표, 일일 활동 통계, 이벤트 통계, 세션 통계 포함

### 2. 디스코드 메시지 전송
```
GET /api/discord/daily-report
```
- 일일 보고서 데이터를 수집하여 디스코드로 전송
- 디스코드 임베드 메시지 포맷팅 적용
- 전송 결과 반환

## 디스코드 메시지 형식

### 리텐션 지표
- ✅ Day1 리텐션: 45.2% (목표: 40%)
- ⚠️ Week1 완료율: 35.8% (목표: 50%)
- ✅ Day7 리텐션: 28.5% (목표: 25%)
- ❌ Day30 완주율: 8.2% (목표: 10%)
- ✅ 긍정 후기: 72.1% (목표: 70%)

### 일일 활동 통계
- 활성 사용자: 15명
- 실천 완료: 12명
- 피드백 제출: 10명
- AI 상담 이용: 8명

### 주요 이벤트
- 실천 완료: 25회 (15명)
- AI 상담 시작: 18회 (12명)
- 피드백 제출: 22회 (14명)

### 세션 통계
- 총 세션: 45개
- 고유 사용자: 28명
- 평균 방문/세션: 2.3회
- 평균 이벤트/세션: 5.7회

## 스케줄링

### Cron Job 설정
- **실행 시간**: 매일 오전 9시 (UTC 기준)
- **설정 파일**: `workers/wrangler.toml`
- **Cron 표현식**: `0 9 * * *`

### 시간대 고려사항
- Cron Job은 UTC 기준으로 실행
- 한국 시간 오전 9시 = UTC 0시
- 실제로는 UTC 0시에 실행되므로 한국 시간으로는 오전 9시

## 에러 처리

### 자동 에러 알림
- Cron Job 실행 실패 시 슬랙에 에러 메시지 자동 전송
- 에러 메시지에 상세 정보 포함
- 슬랙 메시지 전송도 실패할 경우 콘솔에 로그 기록

### 수동 에러 확인
```bash
# Workers 로그 확인
npx wrangler tail
```

## 모니터링

### 성공적인 실행 확인
1. 슬랙 채널에서 매일 오전 9시에 보고서 수신 확인
2. Workers 대시보드에서 Cron Job 실행 로그 확인
3. API 엔드포인트 수동 호출로 데이터 정상성 확인

### 문제 해결
1. **슬랙 메시지가 오지 않는 경우**
   - SLACK_WEBHOOK_URL 시크릿 설정 확인
   - 슬랙 앱 권한 설정 확인
   - Workers 로그에서 에러 메시지 확인

2. **데이터가 비어있는 경우**
   - 데이터베이스 연결 상태 확인
   - 사용자 활동 데이터 존재 여부 확인
   - API 엔드포인트 수동 테스트

3. **Cron Job이 실행되지 않는 경우**
   - wrangler.toml 설정 확인
   - Workers 배포 상태 확인
   - Cloudflare 대시보드에서 Cron Job 설정 확인

## 커스터마이징

### 보고서 내용 수정
- `formatSlackMessage()` 함수에서 메시지 형식 수정
- `getDailyReportData()` 함수에서 수집 데이터 범위 조정

### 실행 시간 변경
- `wrangler.toml`의 `crons` 설정 수정
- Cron 표현식 형식: `분 시 일 월 요일`

### 추가 지표 포함
- `getDailyReportData()` 함수에 새로운 데이터 수집 로직 추가
- `formatSlackMessage()` 함수에 새로운 섹션 추가

## 보안 고려사항

### 시크릿 관리
- SLACK_WEBHOOK_URL은 반드시 `wrangler secret`으로 설정
- 코드에 하드코딩하지 않음
- 정기적인 시크릿 로테이션 권장

### 접근 제어
- API 엔드포인트는 인증 없이 접근 가능
- 필요시 API 키 기반 인증 추가 고려
- 슬랙 웹훅 URL은 공개되지 않도록 주의

## 성능 최적화

### 데이터베이스 쿼리 최적화
- 인덱스 설정으로 쿼리 성능 향상
- 불필요한 데이터 조회 최소화
- 캐싱 전략 적용 고려

### 메시지 전송 최적화
- 슬랙 API 호출 실패 시 재시도 로직
- 메시지 크기 제한 고려
- 비동기 처리로 응답 시간 단축

---

**단단이 개발팀**  
마지막 업데이트: 2025-01-27
